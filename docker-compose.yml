services:
  # ----------------------------------------
  # Redis Cache
  # ----------------------------------------
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------
  # Python ML API
  # ----------------------------------------
  ml-api:
    build:
      context: ./backend-python
      dockerfile: Dockerfile
    image: hsbc-ml-api:final
    ports:
      - "8000:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:8000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------
  # Java Market API
  # ----------------------------------------
  java-api:
    build:
      context: ./backend-java
      dockerfile: Dockerfile
    image: hsbc-java-api:final
    ports:
      - "8080:8080"
    restart: unless-stopped

    # ACTUATOR 健康檢查
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:8080/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

    depends_on:
      redis:
        condition: service_healthy
      ml-api:
        condition: service_healthy

    environment:
      - SPRING_DATA_REDIS_HOST=redis
      - ML_API_BASE_URL=http://ml-api:8000

  # ----------------------------------------
  # Next.js Portal
  # ----------------------------------------
  portal:
    build:
      context: ./frontend-portal
      dockerfile: Dockerfile
    image: hsbc-portal:final
    ports:
      - "3000:3000"
    restart: unless-stopped

    depends_on:
      java-api:
        condition: service_healthy
      ml-api:
        condition: service_healthy

    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_JAVA_API_URL=http://java-api:8080
      - NEXT_PUBLIC_ML_API_URL=http://ml-api:8000

